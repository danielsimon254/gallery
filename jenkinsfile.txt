pipeline {
    agent any  // Use any available agent

    environment {
        // GitHub Token stored securely in Jenkins
        GITHUB_TOKEN = credentials('github-token')  // GitHub Personal Access Token (to be added to Jenkins credentials)
        
        // Heroku API Key stored securely in Jenkins
        HEROKU_API_KEY = credentials('HRKU-f5bd0574-c37f-4e52-9fbf-c9cc10470167')  // Heroku API Key (already added to Jenkins credentials)

        // Heroku app name
        HEROKU_APP_NAME = 'danielsimon-app'  // Your Heroku app name

        // GitHub repository URL
        GITHUB_REPO = 'https://github.com/danielsimon254/gallery'  // Your GitHub repository URL
    }

    stages {
        stage('Checkout SCM') {
            steps {
                checkout scm  // Checkout the repository from GitHub
            }
        }

        stage('Push Jenkinsfile to GitHub') {
            steps {
                script {
                    // Ensure the GitHub token is available for pushing
                    withCredentials([string(credentialsId: 'github-token', variable: 'GITHUB_TOKEN')]) {
                        // Configure GitHub user email and username
                        sh 'git config --global user.email "simondaniel254@gmail.com"'  // GitHub email
                        sh 'git config --global user.name "danielsimon254"'  // GitHub username

                        // Ensure you're on the correct branch (master or main)
                        sh 'git checkout master'  // Change to the desired branch if needed

                        // Add and commit changes to the Jenkinsfile or any other file
                        sh 'git add Jenkinsfile'  // Add the Jenkinsfile or other changes
                        sh 'git commit -m "Updated Jenkinsfile for Heroku deployment"'

                        // Push changes to GitHub using the token for authentication
                        sh 'git push https://${GITHUB_TOKEN}@github.com/danielsimon254/gallery.git master'  // Push to the repository
                    }
                }
            }
        }

        stage('Deploy to Heroku') {
            steps {
                script {
                    // Authenticate with Heroku using the API key
                    echo "Authenticating with Heroku..."
                    sh '''
                    echo $HEROKU_API_KEY | heroku auth:token
                    '''

                    // Remove any existing Heroku remote and set it up for deployment
                    echo "Configuring Git remote for Heroku..."
                    sh '''
                    git remote remove heroku || true  # Remove any existing Heroku remote
                    git remote add heroku https://git.heroku.com/$HEROKU_APP_NAME.git
                    '''

                    // Deploy to Heroku (push the changes)
                    echo "Pushing to Heroku..."
                    sh 'git push heroku master'  // Push the code to Heroku (default is 'master' branch)
                }
            }
        }
    }

    post {
        success {
            echo 'Pipeline executed successfully.'
        }
        failure {
            echo 'Pipeline failed.'
        }
    }
}
